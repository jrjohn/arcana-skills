<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{PROJECT_NAME}} - Device Preview</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --device-bezel: #1d1d1f;
      --device-bezel-inner: #2d2d2f;
    }

    body {
      background: #ffffff;
      min-height: 100vh;
    }

    /* iPad Pro Frame */
    .ipad-frame {
      background: linear-gradient(145deg, #2d2d2f, #1a1a1c);
      border-radius: 40px;
      padding: 24px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.1),
        0 50px 100px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.1);
      position: relative;
    }

    .ipad-frame::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 10px;
      transform: translateY(-50%);
      width: 4px;
      height: 100px;
      background: linear-gradient(to bottom, #3a3a3c, #2a2a2c);
      border-radius: 2px;
    }

    .ipad-frame .camera {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background: radial-gradient(circle at 30% 30%, #4a4a4c, #1a1a1c);
      border-radius: 50%;
      box-shadow: inset 0 0 3px rgba(0,0,0,0.5);
    }

    .ipad-screen {
      width: 1024px;
      height: 768px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.3);
    }

    .ipad-screen iframe {
      width: 1194px;
      height: 834px;
      transform: scale(0.857);
      transform-origin: top left;
      border: none;
    }

    /* iPad Mini Frame */
    .ipad-mini-frame {
      background: linear-gradient(145deg, #2d2d2f, #1a1a1c);
      border-radius: 32px;
      padding: 18px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.1),
        0 40px 80px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.1);
      position: relative;
    }

    .ipad-mini-frame .camera {
      position: absolute;
      top: 50%;
      right: 8px;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: radial-gradient(circle at 30% 30%, #4a4a4c, #1a1a1c);
      border-radius: 50%;
    }

    .ipad-mini-screen {
      width: 597px;
      height: 417px;
      background: #000;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .ipad-mini-screen iframe {
      width: 1194px;
      height: 834px;
      transform: scale(0.5);
      transform-origin: top left;
      border: none;
    }

    /* iPhone Frame */
    .iphone-frame {
      background: linear-gradient(145deg, #2d2d2f, #1a1a1c);
      border-radius: 55px;
      padding: 12px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.1),
        0 40px 80px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.1);
      position: relative;
    }

    .iphone-frame .dynamic-island {
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: 126px;
      height: 37px;
      background: #000;
      border-radius: 20px;
      z-index: 10;
    }

    .iphone-frame .side-button {
      position: absolute;
      right: -3px;
      top: 140px;
      width: 4px;
      height: 80px;
      background: linear-gradient(to right, #3a3a3c, #2a2a2c);
      border-radius: 0 2px 2px 0;
    }

    .iphone-frame .volume-up {
      position: absolute;
      left: -3px;
      top: 100px;
      width: 4px;
      height: 32px;
      background: linear-gradient(to left, #3a3a3c, #2a2a2c);
      border-radius: 2px 0 0 2px;
    }

    .iphone-frame .volume-down {
      position: absolute;
      left: -3px;
      top: 140px;
      width: 4px;
      height: 50px;
      background: linear-gradient(to left, #3a3a3c, #2a2a2c);
      border-radius: 2px 0 0 2px;
    }

    .iphone-frame .mute-switch {
      position: absolute;
      left: -3px;
      top: 70px;
      width: 4px;
      height: 20px;
      background: linear-gradient(to left, #3a3a3c, #2a2a2c);
      border-radius: 2px 0 0 2px;
    }

    .iphone-screen {
      width: 393px;
      height: 852px;
      background: #000;
      border-radius: 45px;
      overflow: hidden;
      position: relative;
    }

    .iphone-screen iframe {
      width: 393px;
      height: 852px;
      border: none;
    }

    /* Hide scrollbars */
    .ipad-screen iframe,
    .ipad-mini-screen iframe,
    .iphone-screen iframe {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .ipad-screen iframe::-webkit-scrollbar,
    .ipad-mini-screen iframe::-webkit-scrollbar,
    .iphone-screen iframe::-webkit-scrollbar {
      display: none;
    }

    /* Device Selector */
    .device-btn {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .device-btn:hover {
      transform: translateY(-2px);
      background: rgba(99, 102, 241, 0.1);
    }

    .device-btn.active {
      background: white;
      color: #4F46E5;
      border-color: #6366F1;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* Screen List */
    .screen-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .screen-item:hover {
      background: rgba(99, 102, 241, 0.08);
    }

    .screen-item.active {
      background: rgba(99, 102, 241, 0.15);
      border-left-color: #6366F1;
    }

    /* Module Badge Colors - Customize for your project */
    .badge-auth { background: #6366F1; }
    .badge-onboard { background: #8B5CF6; }
    .badge-dash { background: #F59E0B; }
    .badge-home { background: #3B82F6; }
    .badge-vocab { background: #10B981; }
    .badge-train { background: #F59E0B; }
    .badge-feature { background: #10B981; }
    .badge-prog { background: #8B5CF6; }
    .badge-report { background: #3B82F6; }
    .badge-setting { background: #64748B; }

    /* Scrollbar */
    .screen-list::-webkit-scrollbar {
      width: 6px;
    }

    .screen-list::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.05);
      border-radius: 3px;
    }

    .screen-list::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }

    /* Preview container */
    .preview-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 40px;
    }

    /* Device label */
    .device-label {
      position: absolute;
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #f3f4f6;
      color: #374151;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="overflow-hidden">

  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-white shadow-2xl flex flex-col z-10">
      <!-- Logo -->
      <div class="p-5 border-b border-gray-100">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center">
            <span class="text-xl">{{PROJECT_ICON}}</span>
          </div>
          <div>
            <h1 class="font-bold text-gray-800 text-lg">{{PROJECT_NAME}}</h1>
            <p class="text-xs text-gray-500">Device Preview</p>
          </div>
        </div>
      </div>

      <!-- Device Selector -->
      <div class="p-4 border-b border-gray-100">
        <p class="text-xs font-semibold text-gray-400 mb-3 tracking-wider">DEVICE TYPE</p>
        <div class="flex gap-2">
          <button onclick="setDevice('ipad')" class="device-btn active flex-1 px-3 py-3 rounded-xl text-sm font-medium bg-gray-50 text-gray-600" id="btn-ipad">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="3" y="2" width="18" height="20" rx="2" stroke-width="1.5"/>
              <line x1="3" y1="18" x2="21" y2="18" stroke-width="1.5"/>
            </svg>
            iPad
          </button>
          <button onclick="setDevice('ipad-mini')" class="device-btn flex-1 px-3 py-3 rounded-xl text-sm font-medium bg-gray-50 text-gray-600" id="btn-ipad-mini">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="5" y="3" width="14" height="18" rx="2" stroke-width="1.5"/>
              <line x1="5" y1="17" x2="19" y2="17" stroke-width="1.5"/>
            </svg>
            iPad Mini
          </button>
          <button onclick="setDevice('iphone')" class="device-btn flex-1 px-3 py-3 rounded-xl text-sm font-medium bg-gray-50 text-gray-600" id="btn-iphone">
            <svg class="w-6 h-6 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <rect x="6" y="2" width="12" height="20" rx="3" stroke-width="1.5"/>
              <rect x="9" y="4" width="6" height="2" rx="1" fill="currentColor"/>
            </svg>
            iPhone
          </button>
        </div>
      </div>

      <!-- Screen List -->
      <div class="flex-1 overflow-y-auto screen-list">
        <div class="p-4">
          <p class="text-xs font-semibold text-gray-400 mb-3 tracking-wider">SCREENS ({{TOTAL_SCREENS}})</p>

          <!-- {{MODULE_SECTIONS}} -->
          <!-- Each module section should follow this format:
          <div class="mb-5">
            <p class="text-xs font-semibold text-gray-500 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 rounded-full badge-{module}"></span>
              {MODULE} ({COUNT})
            </p>
            <div class="space-y-1">
              <div class="screen-item active px-3 py-2.5 rounded-lg cursor-pointer" onclick="loadScreen('{module}/SCR-{MODULE}-001-{name}.html', this)" data-iphone="iphone/SCR-{MODULE}-001-{name}.html">
                <span class="text-sm text-gray-700">SCR-{MODULE}-001 {Screen Name}</span>
              </div>
            </div>
          </div>
          -->

          <!-- Example AUTH Module -->
          <div class="mb-5">
            <p class="text-xs font-semibold text-gray-500 mb-2 flex items-center gap-2">
              <span class="w-2 h-2 rounded-full badge-auth"></span>
              AUTH ({{AUTH_COUNT}})
            </p>
            <div class="space-y-1">
              <div class="screen-item active px-3 py-2.5 rounded-lg cursor-pointer" onclick="loadScreen('auth/SCR-AUTH-001-login.html', this)" data-iphone="iphone/SCR-AUTH-001-login.html">
                <span class="text-sm text-gray-700">SCR-AUTH-001 登入頁面</span>
              </div>
              <div class="screen-item px-3 py-2.5 rounded-lg cursor-pointer" onclick="loadScreen('auth/SCR-AUTH-002-register.html', this)" data-iphone="iphone/SCR-AUTH-002-register.html">
                <span class="text-sm text-gray-700">SCR-AUTH-002 註冊頁面</span>
              </div>
              <div class="screen-item px-3 py-2.5 rounded-lg cursor-pointer" onclick="loadScreen('auth/SCR-AUTH-003-forgot-password.html', this)" data-iphone="iphone/SCR-AUTH-003-forgot-password.html">
                <span class="text-sm text-gray-700">SCR-AUTH-003 忘記密碼</span>
              </div>
              <div class="screen-item px-3 py-2.5 rounded-lg cursor-pointer" onclick="loadScreen('auth/SCR-AUTH-003a-forgot-sent.html', this)" data-iphone="iphone/SCR-AUTH-003a-forgot-sent.html">
                <span class="text-sm text-gray-700">SCR-AUTH-003a 重設連結已發送</span>
              </div>
            </div>
          </div>

          <!-- Add more module sections as needed -->

        </div>
      </div>

      <!-- Footer -->
      <div class="p-4 border-t border-gray-100 bg-gray-50">
        <a href="index.html" class="flex items-center justify-center gap-2 text-sm text-gray-600 hover:text-indigo-600 transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          返回畫面總覽
        </a>
      </div>
    </div>

    <!-- Preview Area -->
    <div class="flex-1 bg-gradient-to-br from-slate-100 via-slate-150 to-slate-200 overflow-auto">
      <div class="preview-container">

        <!-- iPad Pro Frame -->
        <div id="device-ipad" class="ipad-frame relative">
          <div class="camera"></div>
          <div class="ipad-screen">
            <iframe id="preview-iframe-ipad" src="auth/SCR-AUTH-001-login.html"></iframe>
          </div>
          <div class="device-label">iPad Pro - 1024 x 768 (scaled from 1194 x 834)</div>
        </div>

        <!-- iPad Mini Frame -->
        <div id="device-ipad-mini" class="ipad-mini-frame hidden relative">
          <div class="camera"></div>
          <div class="ipad-mini-screen">
            <iframe id="preview-iframe-ipad-mini" src="auth/SCR-AUTH-001-login.html"></iframe>
          </div>
          <div class="device-label">iPad Mini - 597 x 417</div>
        </div>

        <!-- iPhone Frame -->
        <!-- Note: Uses iPad version by default. If iPhone-specific screens exist in iphone/, update src accordingly -->
        <div id="device-iphone" class="iphone-frame hidden relative">
          <div class="dynamic-island"></div>
          <div class="side-button"></div>
          <div class="volume-up"></div>
          <div class="volume-down"></div>
          <div class="mute-switch"></div>
          <div class="iphone-screen">
            <iframe id="preview-iframe-iphone" src="auth/SCR-AUTH-001-login.html"></iframe>
          </div>
          <div class="device-label">iPhone 16 Pro - 393 x 852</div>
        </div>

      </div>
    </div>
  </div>

  <script>
    let currentDevice = 'ipad';
    let currentScreen = 'auth/SCR-AUTH-001-login.html';
    let currentElement = document.querySelector('.screen-item.active');

    function setDevice(device) {
      document.getElementById('device-ipad').classList.add('hidden');
      document.getElementById('device-ipad-mini').classList.add('hidden');
      document.getElementById('device-iphone').classList.add('hidden');

      document.getElementById('btn-ipad').classList.remove('active');
      document.getElementById('btn-ipad-mini').classList.remove('active');
      document.getElementById('btn-iphone').classList.remove('active');

      document.getElementById('device-' + device).classList.remove('hidden');
      document.getElementById('btn-' + device).classList.add('active');

      currentDevice = device;
      updateIframeSrc();
    }

    function loadScreen(url, element) {
      currentScreen = url;
      currentElement = element;

      document.querySelectorAll('.screen-item').forEach(item => {
        item.classList.remove('active');
      });

      element.classList.add('active');
      element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      updateIframeSrc();
    }

    function updateIframeSrc() {
      // Use iPad URL for all devices by default (iPhone uses scaled iPad version)
      // If iPhone-specific screens exist, change USE_IPHONE_SCREENS to true
      const USE_IPHONE_SCREENS = false;

      let ipadUrl = currentScreen;

      // If currentScreen starts with 'iphone/', convert back to iPad path
      if (currentScreen.startsWith('iphone/')) {
        if (currentElement) {
          const onclick = currentElement.getAttribute('onclick');
          if (onclick) {
            const match = onclick.match(/loadScreen\('([^']+)'/);
            if (match) {
              ipadUrl = match[1];
            }
          }
        }
      }

      // Set iPad iframes to iPad URL
      document.getElementById('preview-iframe-ipad').src = ipadUrl;
      document.getElementById('preview-iframe-ipad-mini').src = ipadUrl;

      // Set iPhone iframe - use iPad fallback or dedicated iPhone screens
      if (USE_IPHONE_SCREENS && currentElement) {
        const dataIphone = currentElement.getAttribute('data-iphone');
        if (dataIphone) {
          document.getElementById('preview-iframe-iphone').src = dataIphone;
        } else {
          // Fallback: derive iPhone path from iPad path
          const iphoneUrl = ipadUrl.replace(/^([a-z]+)\//, 'iphone/');
          document.getElementById('preview-iframe-iphone').src = iphoneUrl;
        }
      } else {
        // Default: Use iPad version for iPhone (scaled display)
        document.getElementById('preview-iframe-iphone').src = ipadUrl;
      }
    }

    function syncSidebarFromIframe(iframeSrc) {
      const urlParts = iframeSrc.split('/');
      const filename = urlParts[urlParts.length - 1].split('?')[0].split('#')[0];

      // Extract screen ID (e.g., "SCR-AUTH-004" from "SCR-AUTH-004-role.html")
      const screenIdMatch = filename.match(/SCR-[A-Z]+-\d+[a-z]?/);
      if (!screenIdMatch) return;

      const screenId = screenIdMatch[0];

      // Also extract the relative path for data-iphone matching
      const pathMatch = iframeSrc.match(/(?:iphone|auth|home|vocab|train|report|setting|onboard|dash)\/[^?#]+/);
      const relativePath = pathMatch ? pathMatch[0] : null;

      const screenItems = document.querySelectorAll('.screen-item');
      let foundItem = null;

      screenItems.forEach(item => {
        const onclick = item.getAttribute('onclick');
        const dataIphone = item.getAttribute('data-iphone');
        const text = item.textContent || item.innerText;

        // Match by: data-iphone path, onclick path, or screen ID in text
        if (relativePath && dataIphone && dataIphone.includes(relativePath)) {
          foundItem = item;
        } else if (relativePath && onclick && onclick.includes(relativePath)) {
          foundItem = item;
        } else if (text.includes(screenId)) {
          foundItem = item;
        }
      });

      if (foundItem && foundItem !== currentElement) {
        screenItems.forEach(item => {
          item.classList.remove('active');
        });

        foundItem.classList.add('active');
        currentElement = foundItem;

        // Update currentScreen based on current device
        if (currentDevice === 'iphone') {
          const iphoneUrl = foundItem.getAttribute('data-iphone');
          if (iphoneUrl) {
            currentScreen = iphoneUrl;
          }
        } else {
          const onclick = foundItem.getAttribute('onclick');
          if (onclick) {
            const urlMatch = onclick.match(/loadScreen\('([^']+)'/);
            if (urlMatch) {
              currentScreen = urlMatch[1];
            }
          }
        }

        foundItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function getActiveIframe() {
      if (!document.getElementById('device-ipad').classList.contains('hidden')) {
        return document.getElementById('preview-iframe-ipad');
      } else if (!document.getElementById('device-ipad-mini').classList.contains('hidden')) {
        return document.getElementById('preview-iframe-ipad-mini');
      } else {
        return document.getElementById('preview-iframe-iphone');
      }
    }

    function setupIframeListeners() {
      const iframes = [
        document.getElementById('preview-iframe-ipad'),
        document.getElementById('preview-iframe-ipad-mini'),
        document.getElementById('preview-iframe-iphone')
      ];

      iframes.forEach(iframe => {
        iframe.addEventListener('load', function() {
          if (iframe === getActiveIframe()) {
            try {
              const iframeSrc = iframe.contentWindow.location.href;
              syncSidebarFromIframe(iframeSrc);
            } catch (e) {
              // Cross-origin error - ignore
            }
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupIframeListeners();

      const urlParams = new URLSearchParams(window.location.search);

      const deviceParam = urlParams.get('device');
      if (deviceParam && ['ipad', 'ipad-mini', 'iphone'].includes(deviceParam)) {
        setDevice(deviceParam);
      }

      const screenParam = urlParams.get('screen');

      if (screenParam) {
        // Auto-detect device from screen path
        if (screenParam.startsWith('iphone/') && currentDevice !== 'iphone') {
          setDevice('iphone');
        }

        const screenItems = document.querySelectorAll('.screen-item');
        let foundItem = null;

        // Extract screen ID
        const screenIdMatch = screenParam.match(/SCR-[A-Z]+-\d+[a-z]?/);
        const screenId = screenIdMatch ? screenIdMatch[0] : null;

        screenItems.forEach(item => {
          const onclick = item.getAttribute('onclick');
          const dataIphone = item.getAttribute('data-iphone');

          if (onclick && onclick.includes(screenParam)) {
            foundItem = item;
          } else if (dataIphone && dataIphone.includes(screenParam)) {
            foundItem = item;
          } else if (screenId && onclick && onclick.includes(screenId)) {
            foundItem = item;
          } else if (screenId && dataIphone && dataIphone.includes(screenId)) {
            foundItem = item;
          }
        });

        if (foundItem) {
          loadScreen(screenParam, foundItem);
        }
      }
    });

    // Listen for postMessage from iframe (for navigation sync)
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'pageLoaded') {
        syncSidebarFromIframe(event.data.url || event.data.pathname);
      }
    });
  </script>

</body>
</html>
